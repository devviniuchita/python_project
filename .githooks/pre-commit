#!/bin/bash
# Copyright (c) 2025 Python RAG Project Team
# SPDX-License-Identifier: MIT

set -e

echo "üîç Running pre-commit checks..."
echo ""

# Check if files are staged
if git diff --cached --quiet; then
    echo "‚ö†Ô∏è  No files staged for commit"
    exit 0
fi

# Get staged Python files
STAGED_PY_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.py$' || true)

if [ -z "$STAGED_PY_FILES" ]; then
    echo "‚úÖ No Python files to check"
    exit 0
fi

echo "üìù Checking Python files:"
echo "$STAGED_PY_FILES"
echo ""

# Check for copyright headers
MISSING_COPYRIGHT=()
CURRENT_YEAR=$(date +%Y)

for file in $STAGED_PY_FILES; do
    # Skip test files and __init__.py
    if [[ "$file" == *"test_"* ]] || [[ "$file" == *"__init__.py" ]]; then
        continue
    fi

    # Check if file exists (could be deleted)
    if [ ! -f "$file" ]; then
        continue
    fi

    # Check for copyright
    if ! grep -q "Copyright (c)" "$file"; then
        MISSING_COPYRIGHT+=("$file")
    fi
done

if [ ${#MISSING_COPYRIGHT[@]} -ne 0 ]; then
    echo "‚ùå The following files are missing copyright headers:"
    printf '%s\n' "${MISSING_COPYRIGHT[@]}"
    echo ""
    echo "Run: python scripts/add_copyright_headers.py"
    echo "Or add manually:"
    echo ""
    echo '"""'
    echo 'Module description.'
    echo ""
    echo "Copyright (c) $CURRENT_YEAR Python RAG Project Team"
    echo "SPDX-License-Identifier: MIT"
    echo 'Author: Vin√≠cius Uchita <viniciusuchita@gmail.com>'
    echo '"""'
    echo ""
    exit 1
fi

echo "‚úÖ All files have copyright headers"
echo ""

# Run formatters
echo "üé® Running Black..."
black --check $STAGED_PY_FILES || {
    echo "‚ùå Black formatting failed"
    echo "Run: black src/ tests/"
    exit 1
}

echo "‚úÖ Black passed"
echo ""

echo "üì¶ Running isort..."
isort --check-only $STAGED_PY_FILES || {
    echo "‚ùå isort failed"
    echo "Run: isort src/ tests/"
    exit 1
}

echo "‚úÖ isort passed"
echo ""

echo "üîç Running flake8..."
flake8 $STAGED_PY_FILES || {
    echo "‚ùå flake8 failed"
    exit 1
}

echo "‚úÖ flake8 passed"
echo ""

echo "üéâ All pre-commit checks passed!"
