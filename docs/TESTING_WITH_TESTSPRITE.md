# Testing with TestSprite - Backend Integration Guide

> **Status**: T-39 - TestSprite Integration
> **Last Updated**: 2025-10-18
> **Integration Level**: Backend Python (pytest + TestSprite MCP)

---

## 🎯 Overview

This guide explains how TestSprite integrates with our backend testing infrastructure to provide **dynamic testing** complementing SonarQube's **static analysis**.

### The Quality Assurance Stack

```
┌──────────────────────────────────────────────────────────┐
│         Comprehensive Quality Assurance Pipeline         │
├──────────────────────────────────────────────────────────┤
│                                                          │
│  ✅ Layer 1: Code Governance                            │
│     - Copyright Headers (T-31): 27/27 tests passing      │
│     - License headers automated                          │
│                                                          │
│  ✅ Layer 2: Local Validation (Pre-commit, T-33)        │
│     - Black formatting                                  │
│     - isort import sorting                              │
│     - flake8 linting                                    │
│     - mypy type checking                                │
│                                                          │
│  ✅ Layer 3: Static Analysis (SonarQube, T-32)          │
│     - Cognitive Complexity < 15                         │
│     - Duplication < 3%                                  │
│     - Coverage > 80%                                    │
│     - Security hotspots (OWASP Top 10)                  │
│                                                          │
│  ⏳ Layer 4: Dynamic Testing (TestSprite, T-39)         │
│     - Auto-generated test cases (9 tests)               │
│     - Backend API testing                               │
│     - Conversation flow validation                      │
│     - Quality threshold testing                         │
│                                                          │
└──────────────────────────────────────────────────────────┘
```

---

## 📋 What is TestSprite?

**TestSprite** is an AI-powered testing agent that:

1. **Analyzes your codebase** and understands functionality
2. **Generates test plans** automatically (9 test cases generated)
3. **Creates test code** in pytest format
4. **Executes tests** and generates detailed reports
5. **Provides insights** on code coverage and quality gaps

### For Python Backends (Our Approach):

- **Framework**: pytest + TestSprite MCP
- **Execution**: Code-based testing (not HTTP)
- **Focus**: Business logic, APIs, and data flows
- **Reports**: JSON + Markdown in `/docs/testsprite_results/`

---

## 🚀 Quick Start

### 1. Install Dependencies

```bash
# Ensure pytest and coverage are installed
pip install pytest pytest-cov pytest-mock

# Optional: Install development dependencies
pip install -e ".[dev]"
```

### 2. Run Existing Tests

```bash
# Run all passing tests (baseline)
pytest tests/test_add_copyright_headers.py -v

# Run with coverage
pytest tests/ -v --cov=src --cov-report=html
```

### 3. Review Generated Test Plan

TestSprite generated 9 test cases. View them:

```bash
# Backend test plan (auto-generated by TestSprite)
cat testsprite_tests/testsprite_backend_test_plan.json

# Test report
cat docs/testsprite_results/TESTSPRITE_REPORT.md
```

### 4. Check Test Report

```bash
# View full test execution report
cat docs/testsprite_results/TESTSPRITE_REPORT.md

# View JSON report
cat docs/testsprite_results/test_report_backend.json
```

---

## 🧪 Generated Test Cases (T-39)

TestSprite auto-generated 9 critical test cases:

| ID     | Test Case                                  | Purpose                       | Status     |
| ------ | ------------------------------------------ | ----------------------------- | ---------- |
| TC_001 | test_document_retrieval_functionality      | Verify document retrieval API | 📝 PLANNED |
| TC_002 | test_document_reranking_functionality      | Test BGE reranking            | 📝 PLANNED |
| TC_003 | test_llm_generation_response               | Validate LLM generation       | 📝 PLANNED |
| TC_004 | test_create_conversation_api               | Test conversation creation    | 📝 PLANNED |
| TC_005 | test_add_message_to_conversation           | Test message addition         | 📝 PLANNED |
| TC_006 | test_get_conversation_context_api          | Test context retrieval        | 📝 PLANNED |
| TC_007 | test_quality_validation_response_threshold | Test quality thresholds       | 📝 PLANNED |
| TC_008 | test_confidence_score_calculation          | Test score calculation        | 📝 PLANNED |
| TC_009 | test_adaptive_threshold_application        | Test adaptive thresholds      | 📝 PLANNED |

**Location**: `testsprite_tests/testsprite_backend_test_plan.json`

---

## 🔧 Fixing Infrastructure (Phase 1)

### Issue: Python Import Paths

20 tests are currently failing due to module import errors. Fix with:

```bash
# Option 1: Set PYTHONPATH
export PYTHONPATH="${PYTHONPATH}:$(pwd)/src"
pytest tests/ -v

# Option 2: Install in development mode
pip install -e .
pytest tests/ -v

# Option 3: Run from project root
cd c:\Users\ADMIN\Desktop\python_project
python -m pytest tests/ -v
```

### Verification

```bash
# Should import successfully
python -c "from src.features.reranking import reranker; print('✅ Import OK')"

# Re-run tests
pytest tests/unit/test_reranker.py -v
```

---

## 📊 Current Test Coverage

### Baseline Results (Current)

```
Total Tests:     48
├── Passing:     27 ✅ (56.25%)
│   └── Copyright Headers: 27/27 tests
├── Failing:     20 ❌ (41.67%)
│   ├── RAG Reranking: 0/11 (import issues)
│   └── Threshold Filtering: 0/10 (import issues)
└── Skipped:     1 ⏭️ (2.08%)
```

### Expected After Fixes (Goal)

```
Total Tests:     57 (48 existing + 9 generated)
├── Passing:     50+ ✅ (87.7%+)
├── Failing:     < 5 ❌ (edge cases)
└── Skipped:     1 ⏭️ (model loading)
```

---

## 🛠️ Helper Script: run_testsprite.sh

Create `/scripts/run_testsprite.sh`:

```bash
#!/bin/bash

# Color output
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${BLUE}🧪 TestSprite Test Execution${NC}"
echo "================================"

# Check Python
python -c "import pytest" 2>/dev/null || { echo -e "${RED}❌ pytest not installed${NC}"; exit 1; }

# Fix PYTHONPATH
export PYTHONPATH="${PYTHONPATH}:$(pwd)/src"
echo -e "${YELLOW}✓ PYTHONPATH configured${NC}"

# Generate coverage report
echo -e "${YELLOW}Generating coverage report...${NC}"
python -m pytest tests/ \
  -v \
  --cov=src \
  --cov-report=html \
  --cov-report=term \
  --tb=short \
  --json-report \
  --json-report-file=docs/testsprite_results/pytest_report.json

# Display summary
echo -e "${GREEN}✅ Test execution complete!${NC}"
echo "Reports:"
echo "  - HTML: docs/testsprite_results/pytest_report.json"
echo "  - Markdown: docs/testsprite_results/TESTSPRITE_REPORT.md"
echo "  - Coverage HTML: htmlcov/index.html"
```

Make executable:

```bash
chmod +x scripts/run_testsprite.sh
./scripts/run_testsprite.sh
```

---

## 🔄 CI/CD Integration

### GitHub Actions Workflow

Create `.github/workflows/testsprite-automation.yml`:

```yaml
name: TestSprite Backend Testing

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.10', '3.11', '3.12']

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .
          pip install pytest pytest-cov pytest-mock pytest-json-report

      - name: Run TestSprite tests
        env:
          PYTHONPATH: src
        run: |
          pytest tests/ \
            -v \
            --cov=src \
            --cov-report=xml \
            --cov-report=html \
            --cov-report=term \
            --tb=short \
            --json-report \
            --json-report-file=testsprite_tests/pytest_report.json

      - name: Upload coverage to SonarQube
        uses: sonarsource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

      - name: Upload test reports
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: testsprite-reports-py${{ matrix.python-version }}
          path: |
            docs/testsprite_results/
            htmlcov/

      - name: Comment PR with results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const report = JSON.parse(fs.readFileSync('testsprite_tests/pytest_report.json', 'utf8'));
            const summary = `### 🧪 TestSprite Test Results\n\n✅ Passed: ${report.summary.passed}\n❌ Failed: ${report.summary.failed}\n⏭️ Skipped: ${report.summary.skipped}`;
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });
```

---

## 📚 Integration with Other Tools

### Relationship with T-31 (Copyright Headers)

- TestSprite tests can verify copyright header enforcement
- Use: `test_copyright_headers_applied()` validates T-31 automation

### Relationship with T-32 (SonarQube)

- SonarQube: Static analysis (what code looks like)
- TestSprite: Dynamic testing (how code behaves)
- Combined: 100% quality coverage

### Relationship with T-33 (Pre-commit)

- Pre-commit: Validates before commit (local)
- TestSprite: Validates after commit (CI/CD)
- Combined: Multi-layer protection

---

## 🎯 TestSprite Test Plan Structure

```json
[
  {
    "id": "TC001",
    "title": "test_document_retrieval_functionality",
    "description": "Verify retrieve_documents API returns top_k docs",
    "category": "RAG Core",
    "priority": "HIGH",
    "status": "PLANNED"
  },
  ...
]
```

---

## 📝 Running Tests Locally

### Quick Test

```bash
# Run copyright header tests (passing)
pytest tests/test_add_copyright_headers.py -v

# Expected: 27 passed
```

### Full Test Suite (After Infrastructure Fixes)

```bash
# Set Python path
export PYTHONPATH="src:$PYTHONPATH"

# Install in dev mode
pip install -e .

# Run all tests
pytest tests/ -v --cov=src --cov-report=term

# Generate HTML report
pytest tests/ --cov=src --cov-report=html
open htmlcov/index.html
```

---

## ✅ Completion Checklist (T-39)

### Phase 1: Infrastructure Fixes ⏳

- [ ] Fix Python import paths
- [ ] Re-run tests to validate fixes
- [ ] Achieve 80%+ pass rate

### Phase 2: Generate Tests ⏳

- [ ] Implement 9 TestSprite-generated test cases
- [ ] Add to pytest suite
- [ ] Validate execution

### Phase 3: CI/CD Setup ⏳

- [ ] Create GitHub Actions workflow
- [ ] Setup SonarQube integration
- [ ] Test on PR

### Phase 4: Documentation ✅

- [ ] Document TestSprite approach (this file)
- [ ] Create helper scripts (run_testsprite.sh)
- [ ] Update README.md
- [ ] Add cross-references

---

## 🔗 Quick Links

- 📄 **Test Report**: `/docs/testsprite_results/TESTSPRITE_REPORT.md`
- 📊 **JSON Report**: `/docs/testsprite_results/test_report_backend.json`
- 📋 **Test Plan**: `/testsprite_tests/testsprite_backend_test_plan.json`
- 🛠️ **Helper Script**: `/scripts/run_testsprite.sh` (create me!)
- 📚 **SonarQube Setup**: `/docs/compliance/SONARQUBE_SETUP.md` (T-32)
- 🔐 **Copyright Headers**: `/docs/COPYRIGHT_PROTECTION.md` (T-31)
- 🎣 **Pre-commit Setup**: `/.pre-commit-config.yaml` (T-33)

---

## 📞 Support & Troubleshooting

### Issue: "ModuleNotFoundError: No module named 'reranker'"

**Solution**:

```bash
export PYTHONPATH="${PYTHONPATH}:$(pwd)/src"
pip install -e .
```

### Issue: "pytest: command not found"

**Solution**:

```bash
pip install pytest pytest-cov pytest-mock
```

### Issue: "Tests are slow"

**Solution**:

```bash
# Skip model loading tests
pytest -m "not slow"

# Use parallel execution
pip install pytest-xdist
pytest -n auto
```

---

**Document Status**: ⏳ In Progress (T-39)
**Last Reviewed**: 2025-10-18
**Next Review**: After Phase 1 infrastructure fixes
